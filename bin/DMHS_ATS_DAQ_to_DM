#!/usr/bin/env python

import time
import sys
import os
import logging
import HeaderService
import HeaderService.SAL_tools as SAL_tools
import HeaderService.hutils as hutils
import socket
    
spinner = hutils.spinner

def get_date(time=None,format='fits'):
    from astropy.time import Time
    from datetime import datetime
    if time is None:
        time = (datetime.now()).isoformat()
    t = Time(time, format=format, scale='utc')
    return t


def run_enable(State,vendor='ITL',filepath='.',tsleep=0.1):

    Filter    = SAL_tools.DDSSubcriber("camera","endSetFilter",Stype="Event")
    StartInt  = SAL_tools.DDSSubcriber("camera","startIntegration",Stype="Event")
    Readout   = SAL_tools.DDSSubcriber("camera","endReadout", Stype="Event")
    takeImages= SAL_tools.DDSSubcriber("camera","takeImages", Stype="Command")
    FK5Target = SAL_tools.DDSSubcriber("tcs","kernel_FK5Target", Stype="Telemetry")
    # And the object to send DMHS messages
    dmhs      = SAL_tools.DDSSend("dmHeaderService")
        
    FK5Target.start()
    Filter.start()
    Readout.start()
    StartInt.start()
    takeImages.start()
    
    # Make sure that we have a place to put the files
    if not os.path.exists(filepath):
        os.makedirs(filepath)
        LOGGER.info("Created dirname:{}".format(filepath))

    # Get the hostname and IP address
    ip_adress = socket.gethostbyname(socket.gethostname())
    
    # Load up the header template
    HDR = HeaderService.HDRTEMPL_ATSCam(vendor=vendor)
    LOGGER = HDR.logger
    
    # For testing start ENABLE
    State.current_state = 'ENABLE'
    loop_n = 0
    while True:

        if State.current_state!='ENABLE':
            sys.stdout.flush()
            sys.stdout.write("Current State is {} [{}]".format(State.current_state,spinner.next()))
            sys.stdout.write('\r') 

        elif StartInt.newEvent:

            # Build the DATE of observation
            DATE_OBS = get_date()

            sys.stdout.flush()
            LOGGER.info("Received: startIntegration Event")
            LOGGER.info("Extracting value for imageName")
            myData = StartInt.getCurrent()
            imageName = myData.imageName
            LOGGER.info("Received: {}".format(imageName))

            # Construct the hdr and fits filename
            filename_HDR  = os.path.join(filepath,"{}.header".format(imageName))
            filename_FITS = "{}.fits".format(imageName)

            # Get takeImages Meta-data
            LOGGER.info("Extracting values for takeImages")
            myData = takeImages.getCurrent()
            exptime, sequenceName = myData.expTime, myData.imageSequenceName
            LOGGER.info("Received: Exptime={}, imageSequenceName={}".format(exptime, sequenceName))

            # Get FK5 Meta-data
            LOGGER.info("Extracting values for FK5 Target")
            myData = FK5Target.getCurrent()
            ra,dec,visitID = myData.ra, myData.dec, int(myData.rv)
            LOGGER.info("Received: RA={}, DEC={}".format(ra,dec))
            
            # Get Filter Meta-data
            LOGGER.info("Extracting value for Filter")
            myData = Filter.getCurrent()
            filter_name = myData.filterName
            LOGGER.info("Received: Filter=%s" % filter_name)

            # Get the readout
            LOGGER.info("Current State is {} -- waiting for Camera Readout event".format(State.current_state))
            Readout.waitEvent()
            if Readout.newEvent:
                sys.stdout.flush()
                LOGGER.info("Received: Readout Signal")
                # Manually Update a header param -- we need to move it a function soon
                # These ones are from Telemetry
                HDR.update_record('FILTER',filter_name, 'PRIMARY')
                HDR.update_record('RA',ra,'PRIMARY')
                HDR.update_record('DEC',dec,'PRIMARY')
                HDR.update_record('RATEL',ra,'PRIMARY')
                HDR.update_record('DECTEL',dec,'PRIMARY')
                HDR.update_record('IMGNAME',imageName,'PRIMARY')
                HDR.update_record('EXPTIME',exptime,'PRIMARY')
                # These values are computed by the DMHS
                HDR.update_record('FILENAME',filename_FITS,'PRIMARY')
                HDR.update_record('DATE-OBS',DATE_OBS.fits,'PRIMARY')
                HDR.update_record('MJD-OBS',DATE_OBS.mjd,'PRIMARY')
                # The creation date -- now!!
                DATE = get_date()
                HDR.update_record('DATE',DATE.fits,'PRIMARY')
                HDR.update_record('MJD',DATE.mjd,'PRIMARY')
                # Write the header 
                HDR.write_header(filename_HDR, newline=False)
                LOGGER.info("Wrote header to: %s" % filename_HDR)
                LOGGER.info("------------------------------------------")
                # Get the md5 for the header file
                md5value = hutils.md5Checksum(filename_HDR) #,blocksize=1024*512):
                bytesize = os.path.getsize(filename_HDR)
                LOGGER.info("Got MD5SUM: %s" % md5value)
                # Now we publish filename and MD5
                # Build the kwargs
                kw = {'Byte_Size':bytesize,
                      'Checksum':md5value,
                      'Generator':'DM Header Service',
                      'Mime':'FITS',
                      'URL': "{}:{}".format(ip_adress,filename_HDR),
                      'Version': 1,
                      'priority':1,
                      }
                dmhs.send_Event('LargeFileObjectAvailable',**kw)
                Readout.newEvent = False
        else:
            sys.stdout.flush()
            sys.stdout.write("Current State is {} -- wating for startIntegration Event...[{}]".format(State.current_state,spinner.next()))
            sys.stdout.write('\r')
            time.sleep(tsleep)

        time.sleep(tsleep)
        loop_n +=1    

if __name__ == "__main__":


    # Init the device and send the current state vis SummaryState.
    # This needs to be done before we star the SAL controller thread,
    # as they use the DeviveState object for the current state
    State = SAL_tools.DeviceState()
    State.send_logEvent('SummaryState')
    
    # Create threads for the controller we want to listen to
    controller_list = ['EnterControl',
                       'ExitControl',
                       'Start',
                       'Standby',
                       'Enable',
                       'Disable']
    tControl = {}
    for ctrl_name in controller_list:
        tControl[ctrl_name] = SAL_tools.DDSController(ctrl_name,State=State)
        tControl[ctrl_name].start()

    run_enable(State,vendor='ITL',filepath='HeaderTester')
    
