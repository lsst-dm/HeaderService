#!/usr/bin/env python

import time
import sys
import os
import logging
import HeaderService
import HeaderService.SAL_tools as SAL_tools
import HeaderService.SAL_tools_send as SAL_tools_send
import HeaderService.hutils as hutils

spinner = hutils.spinner

def run_enable(State,vendor='ITL',filepath='.'):
    
    # Load up the header template
    htempl= HeaderService.HDRTEMPL_TestCamera(vendor=vendor)
    LOGGER = htempl.logger

    
    Filter    = SAL_tools.DDSSubcriber("camera","camera_Filter",Stype="Telemetry")
    Readout   = SAL_tools.DDSSubcriber("camera","camera_logevent_endReadout", Stype="Event")
    FK5Target = SAL_tools.DDSSubcriber("tcs","tcs_kernel_FK5Target", Stype="Telemetry")

        
    FK5Target.start()
    Filter.start()
    Readout.start()

    # Make sure that we have a place to put the files
    if not os.path.exists(filepath):
        os.makedirs(filepath)
        LOGGER.info("Created dirname:{}".format(filepath))
            
    loop_n = 0
    while True:
        
        if State.current_state!='ENABLE':
            sys.stdout.flush()
            sys.stdout.write("Current State is {} [{}]".format(State.current_state,spinner.next()))
            sys.stdout.write('\r') 
        # Get the RA,DEC
        elif FK5Target.newTelem and Filter.newTelem:

            LOGGER.info("New value for FK5 Target")
            myData = FK5Target.getCurrentTelemetry()
            ra,dec,visitID = myData.pmRA, myData.pmDec, int(myData.rv)
            LOGGER.info("Received: RA=%s, DEC=%s" % (ra,dec))
            LOGGER.info("Received: visitID=%s" % visitID)
            filter_name = Filter.get_filter_name()
            LOGGER.info("Received: Filter=%s" % filter_name)

            # Get the readout
            LOGGER.info("Current State is {} -- waiting for Camera Readout event".format(State.current_state))

            Readout.waitEvent()
            if Readout.newEvent:
                sys.stdout.flush()
                LOGGER.info("Received: Readout Signal")
                # Manually Update a header param
                htempl.update_record('FILTER',filter_name, 'PRIMARY_HDU')
                htempl.update_record('IMAGETAG',visitID,'PRIMARY_HDU')
                # Write the header it out
                hout_file = os.path.join(filepath,"LSSTCam_%08d.header" % visitID)
                htempl.write_header(hout_file, newline=False)
                LOGGER.info("Wrote header to: %s" % hout_file)
                LOGGER.info("------------------------------------------")
                # Get the md5 for the header file
                md5value = hutils.md5Checksum(hout_file) #,blocksize=1024*512):
                bytesize = os.path.getsize(hout_file)
                LOGGER.info("Got MD5SUM: %s" % md5value)
                # Now we publish filename and MD5
                # Build the kwargs
                kw = {'Byte_Size':bytesize,
                      'Checksum':md5value,
                      'Generator':'DM_header_test',
                      'Mime':'text/plain',
                      'URL': hout_file,
                      'Version': 1,
                      'priority':1,
                      }
                SAL_tools_send.dmHeaderService_logevent_LargeFileObjectAvailable(**kw)
                Readout.newEvent = False
        else:
            sys.stdout.flush()
            sys.stdout.write("Current State is {} -- wating for new Position/Filter...[{}]".format(State.current_state,spinner.next()))
            sys.stdout.write('\r') 
            time.sleep(0.5)


        time.sleep(0.5)
        loop_n +=1    

if __name__ == "__main__":


    # Init the device and send the current state vis SummaryState.
    # This needs to be done before we star the SAL controller thread,
    # as they use the DeviveState object for the current state
    State = SAL_tools.DeviceState()
    State.send_logEvent('SummaryState')
    
    # Create threads for the controller we want to listen to
    controller_list = ['EnterControl',
                       'ExitControl',
                       'Start',
                       'Standby',
                       'Enable',
                       'Disable']
    tControl = {}
    for ctrl_name in controller_list:
        tControl[ctrl_name] = SAL_tools.DDSController(ctrl_name,State=State)
        tControl[ctrl_name].start()

    run_enable(State,vendor='ITL',filepath='HeaderTester')
    
