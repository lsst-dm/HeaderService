#!/usr/bin/env python

import time
import argparse
from datetime import datetime
import HeaderService.SAL_tools as SAL_tools
import HeaderService.hutils as hutils
LOGGER = hutils.create_logger(name=__name__)


def cmdline():

    DATE = (datetime.now()).isoformat()

    # Make conf_parser that hold values from a config.ini file
    parser = argparse.ArgumentParser(description="Send telemetry to Header Client")

    # The command-line arguments
    parser.add_argument("--ra", action="store",default=None, type=float, 
                        help="The RA of the visit")
    parser.add_argument("--dec", action="store",default=None, type=float,
                        help="The DEC of the visit")
    parser.add_argument("--band", action="store",default=None, 
                        help="Number of CCDs to build")
    parser.add_argument("--imageSequenceName", action="store",default='LSST',
                        help="ImageSequenceName")
    parser.add_argument("--NSequence", action="store",default=2, type=int, 
                        help="Number of exposure in sequence")
    parser.add_argument("--exptime", action="store",default=15, type=float, 
                        help="Exposure time in seconds")
    args = parser.parse_args()
    return args

if __name__ == "__main__":

    args = cmdline()
    
    # Initialize the classes for each device
    # Note that we need a separate object for Commands if we want to wait
    tcs = SAL_tools.DDSSend("tcs")
    cam = SAL_tools.DDSSend("camera")
    #camCommand = SAL_tools.DDSSend("camera")
    camCommand = cam
    
    # Send target postion
    tcs.send_Telemetry("kernel_FK5Target",ra=args.ra,dec=args.dec)
    print tcs.get_myData()
    time.sleep(1)

    # Send endSetFilter
    cam.send_Event("endSetFilter",filterName=args.band)
    print cam.get_myData()
    time.sleep(1)

    # Send the takeImages command
    kw = {'numImages':args.NSequence,
          'expTime': args.exptime,
          'imageSequenceName': args.imageSequenceName,
          'timeout':10}
    camCommand.send_Command('takeImages',**kw)
    #camCommand.start()

    
    LOGGER.info("---Starting Image loop---")
    # Loop over nsequence
    for k in range(args.NSequence):

        LOGGER.info("----Starting Integration {}".format(k))

        # Send startIntegration k
        kw = {'imageSequenceName':args.imageSequenceName,
              'imageName':'{}_{}'.format(args.imageSequenceName,k),
              'imageIndex':str(k),
              'timeStamp':time.time(),
              'priority':1}
        cam.send_Event("startIntegration",**kw)
        time.sleep(args.exptime)

        # Send startReadout Event after integration is finished
        cam.send_Event('startReadout')
        time.sleep(1)

        # Send endReadout event 
        cam.send_Event('endReadout')
        time.sleep(1)

    # Send the ACK
    cam.ackCommand('takeImages',camCommand.cmdId)
    camCommand.waitForCompletion_Command()
    LOGGER.info("Bye...")

